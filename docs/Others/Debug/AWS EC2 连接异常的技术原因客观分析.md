# AWS EC2 连接异常的技术原因客观分析

本次 Java 网盘项目部署中，AWS EC2 服务器连接不稳定的问题，核心源于「网络代理配置」「校园网网络限制」与「流量转发模式」三者的交互异常，具体原因可拆解为以下三点，结合技术逻辑客观说明：

### 一、初始连接报错「Connection closed by remote host」：DNS污染导致连接目标错误

使用 Clash 代理时，出现该报错的本质是**DNS 解析被篡改**：
- Clash 默认的 DNS 转发规则未针对 AWS 域名（`*.amazonaws.com`）做专属配置，导致解析请求被代理劫持，返回虚假 IP（非 EC2 真实公网 IP）；
- SSH 客户端基于错误的解析结果尝试连接，目标主机并非 AWS EC2 实例，因此被远程端主动关闭连接，触发「Connection closed by remote host」错误；
- 即使反复检查 EC2 安全组（出入站规则、端口权限），因连接目标本身错误，无法解决问题。

### 二、关闭 Clash 后无法 ping 通：校园网境外访问限制

关闭 Clash 代理后，出现「无法 ping 通 EC2」的现象，核心是**校园网防火墙的访问控制**：
- 校园网通常会拦截境外 IP 的直接访问（尤其云服务厂商地址），ICMP 协议（ping 命令依赖）和 TCP 22 端口（SSH 依赖）流量均被防火墙阻断；
- 无代理时，本地流量直接通过校园网出口发送，未经过任何转发机制，无法绕过境外访问限制，因此既无法 ping 通，也无法建立 SSH 连接。

### 三、关闭 TUN 模式后秒连：规避流量转发异常

开启 Clash 的 TUN 模式（虚拟网卡）时连接失败，关闭后秒连，本质是**TUN 模式的流量转发机制与 SSH 协议不兼容**：
1. TUN 模式会创建虚拟网卡，接管系统所有网络流量（包括 WSL 2 的流量，因 WSL 共享 Windows 网络栈），流量需经过「虚拟网卡→代理节点」两层转发，相比应用层转发多了一层干预；
2. 该模式下可能出现「MTU 值不匹配」（虚拟网卡 MTU 与 EC2 网络 MTU 不一致，导致 SSH 数据包分片失败）或「协议转发误判」（Clash 未正确识别 SSH 流量，导致转发异常），最终触发「连接重置」；
3. 关闭 TUN 模式后，Clash 仅通过「应用层规则转发」（基于之前配置的 AWS 域名/22 端口规则），流量直接从系统原生网络栈转发至代理节点，无虚拟网卡干预，既保留了代理绕过校园网限制的功能，又避免了转发异常，因此实现秒连。

### 总结

整个问题的核心逻辑链：
`Clash DNS配置不当→DNS污染→连接错误目标（报错）` → `关闭Clash→校园网拦截境外流量（无法访问）` → `关闭TUN模式→应用层规则正常转发→绕过限制+无转发异常（秒连）`。

本质是网络代理配置、网络环境限制与协议转发机制三者的适配问题，通过调整代理的 DNS 规则和关闭不必要的转发模式，即可解决。